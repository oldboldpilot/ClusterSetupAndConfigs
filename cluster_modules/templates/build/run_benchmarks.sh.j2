#!/bin/bash
# Automated benchmark execution script
# Generated by ClusterSetupAndConfigs BenchmarkManager
# 
# Author: Olumuyiwa Oluwasanmi
# Date: {{ generation_date }}

set -e  # Exit on error

# Configuration
NUM_PROCS={{ num_procs }}
BENCHMARK_DIR="{{ benchmark_dir }}"
HOSTFILE="$HOME/.openmpi/hostfile_optimal"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "======================================================================"
echo "  Cluster Benchmark Suite"
echo "======================================================================"
echo "Benchmark Directory: $BENCHMARK_DIR"
echo "Number of Processes: $NUM_PROCS"
echo "Hostfile: $HOSTFILE"
echo "======================================================================"
echo ""

# Check if benchmarks are compiled
if [ ! -f "$BENCHMARK_DIR/bin/mpi_latency" ]; then
    echo -e "${YELLOW}⚠ Benchmarks not compiled. Running make...${NC}"
    cd "$BENCHMARK_DIR"
    make
    echo ""
fi

cd "$BENCHMARK_DIR"

# Function to run a benchmark
run_benchmark() {
    local name=$1
    local executable=$2
    local launcher=$3
    local extra_args=$4
    
    echo -e "${GREEN}▶ Running $name Benchmark${NC}"
    echo "----------------------------------------------------------------------"
    
    if [ ! -f "$executable" ]; then
        echo -e "${RED}✗ Benchmark not found: $executable${NC}"
        echo ""
        return 1
    fi
    
    if [ "$launcher" = "mpirun" ]; then
        mpirun --prefix /home/linuxbrew/.linuxbrew/Cellar/open-mpi/5.0.8 \
               --map-by node \
               -np $NUM_PROCS \
               --hostfile $HOSTFILE \
               $extra_args \
               $executable
    elif [ "$launcher" = "upcxx-run" ]; then
        # UPC++ uses different launcher
        GASNET_SPAWNFN=S \
        GASNET_SSH_SERVERS="$(cat $HOSTFILE | awk '{print $1}' | tr '\n' ' ')" \
        upcxx-run -n $NUM_PROCS $executable
    elif [ "$launcher" = "oshrun" ]; then
        # OpenSHMEM launcher
        oshrun -np $NUM_PROCS --hostfile $HOSTFILE $executable
    elif [ "$launcher" = "none" ]; then
        # Single-node benchmark (OpenMP)
        $executable
    else
        echo -e "${RED}✗ Unknown launcher: $launcher${NC}"
        return 1
    fi
    
    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}✓ $name completed successfully${NC}"
    else
        echo -e "${RED}✗ $name failed with exit code $exit_code${NC}"
    fi
    echo ""
    
    return $exit_code
}

# Track results
TOTAL=0
PASSED=0
FAILED=0

{% for benchmark in benchmarks %}
# {{ benchmark.name }}
((TOTAL++))
if run_benchmark "{{ benchmark.display_name }}" \
                 "bin/{{ benchmark.executable }}" \
                 "{{ benchmark.launcher }}" \
                 "{{ benchmark.extra_args | default('') }}"; then
    ((PASSED++))
else
    ((FAILED++))
fi

{% endfor %}

# Summary
echo "======================================================================"
echo "  Benchmark Summary"
echo "======================================================================"
echo -e "Total:  $TOTAL"
echo -e "${GREEN}Passed: $PASSED${NC}"
if [ $FAILED -gt 0 ]; then
    echo -e "${RED}Failed: $FAILED${NC}"
else
    echo -e "Failed: $FAILED"
fi
echo "======================================================================"

# Exit with failure if any benchmark failed
if [ $FAILED -gt 0 ]; then
    exit 1
fi

exit 0
