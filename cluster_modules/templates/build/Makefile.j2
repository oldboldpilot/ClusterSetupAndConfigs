# Makefile for PGAS Benchmarks
# Generated by ClusterSetupAndConfigs
# Author: Olumuyiwa Oluwasanmi

# Export CXX to use current g++ for UPC++
export CXX = g++

# Compilers
UPCXX = {{ upcxx_compiler }}
MPICXX = {{ mpi_compiler }}
OSHCC = {{ openshmem_compiler }}
UPCC = {{ berkeley_upc_compiler }}
CXX_COMPILER = {{ cxx_compiler }}

# Compiler flags
UPCXX_FLAGS = {{ upcxx_flags }}
MPICXX_FLAGS = {{ mpi_flags }}
OSHCC_FLAGS = {{ openshmem_flags }}
UPCC_FLAGS = {{ berkeley_upc_flags }}
OPENMP_FLAGS = {{ openmp_flags }}

# Directories
SRC_DIR = src
BIN_DIR = bin

# Benchmark targets
BENCHMARKS = {% for benchmark in benchmarks %}{{ benchmark }}{% if not loop.last %} {% endif %}{% endfor %}

# Default target
all: directories $(BENCHMARKS)

# Create directories
directories:
	@mkdir -p $(BIN_DIR)

# UPC++ benchmarks
upcxx_latency: $(SRC_DIR)/upcxx_latency.cpp
	@echo "Compiling UPC++ latency benchmark..."
	$(UPCXX) $(UPCXX_FLAGS) $< -o $(BIN_DIR)/$@

upcxx_bandwidth: $(SRC_DIR)/upcxx_bandwidth.cpp
	@echo "Compiling UPC++ bandwidth benchmark..."
	$(UPCXX) $(UPCXX_FLAGS) $< -o $(BIN_DIR)/$@

# MPI benchmarks
mpi_latency: $(SRC_DIR)/mpi_latency.cpp
	@echo "Compiling MPI latency benchmark..."
	$(MPICXX) $(MPICXX_FLAGS) $< -o $(BIN_DIR)/$@

# OpenSHMEM benchmarks
openshmem_latency: $(SRC_DIR)/openshmem_latency.cpp
	@echo "Compiling OpenSHMEM latency benchmark..."
	$(OSHCC) $(OSHCC_FLAGS) $< -o $(BIN_DIR)/$@ -lstdc++

# Berkeley UPC benchmarks
berkeley_upc_latency: $(SRC_DIR)/berkeley_upc_latency.c
	@echo "Compiling Berkeley UPC latency benchmark..."
	$(UPCC) $(UPCC_FLAGS) $< -o $(BIN_DIR)/$@

# OpenMP benchmarks
openmp_parallel: $(SRC_DIR)/openmp_parallel.cpp
	@echo "Compiling OpenMP parallel benchmark..."
	$(CXX_COMPILER) $(OPENMP_FLAGS) $< -o $(BIN_DIR)/$@

# Hybrid MPI+OpenMP benchmarks
hybrid_mpi_openmp: $(SRC_DIR)/hybrid_mpi_openmp.cpp
	@echo "Compiling hybrid MPI+OpenMP benchmark..."
	$(MPICXX) $(MPICXX_FLAGS) -fopenmp $< -o $(BIN_DIR)/$@

# Clean targets
clean:
	@echo "Cleaning build artifacts..."
	rm -rf $(BIN_DIR)/*

# Help target
help:
	@echo "Available targets:"
	@echo "  all                  - Build all benchmarks (default)"
	@echo "  directories          - Create build directories"
	@echo "  upcxx_latency        - Build UPC++ latency benchmark"
	@echo "  upcxx_bandwidth      - Build UPC++ bandwidth benchmark"
	@echo "  mpi_latency          - Build MPI latency benchmark"
	@echo "  openshmem_latency    - Build OpenSHMEM latency benchmark"
	@echo "  berkeley_upc_latency - Build Berkeley UPC latency benchmark"
	@echo "  clean                - Remove build artifacts"
	@echo "  help                 - Display this help message"

.PHONY: all directories clean help
