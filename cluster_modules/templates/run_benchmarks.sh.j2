#!/bin/bash
# Benchmark Run Script
# Generated by ClusterSetupAndConfigs
# Author: Olumuyiwa Oluwasanmi

set -e

# Configuration
NUM_PROCS={{ num_procs }}
BENCHMARK_DIR="{{ benchmark_dir }}"
BIN_DIR="${BENCHMARK_DIR}/bin"
RESULTS_DIR="${BENCHMARK_DIR}/results"

# Create results directory
mkdir -p "${RESULTS_DIR}"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}=======================================${NC}"
echo -e "${BLUE}  PGAS Benchmark Suite Runner${NC}"
echo -e "${BLUE}=======================================${NC}"
echo ""

# Function to run a benchmark
run_benchmark() {
    local name=$1
    local launcher=$2
    local binary="${BIN_DIR}/${name}"
    local result_file="${RESULTS_DIR}/${name}_$(date +%Y%m%d_%H%M%S).txt"
    
    if [ ! -f "${binary}" ]; then
        echo -e "${RED}✗ ${name}: Binary not found${NC}"
        return 1
    fi
    
    echo -e "${GREEN}Running ${name}...${NC}"
    echo "Output: ${result_file}"
    
    case ${launcher} in
        upcxx-run)
            upcxx-run -n ${NUM_PROCS} "${binary}" | tee "${result_file}"
            ;;
        mpirun)
            # MCA parameters to suppress warnings and handle BTL issues
            mpirun --mca btl_base_warn_component_unused 0 \
                   --mca btl ^openib \
                   --allow-run-as-root \
                   -np ${NUM_PROCS} "${binary}" | tee "${result_file}"
            ;;
        oshrun)
            oshrun -n ${NUM_PROCS} "${binary}" | tee "${result_file}"
            ;;
        upcc-run)
            "${binary}" -n ${NUM_PROCS} | tee "${result_file}"
            ;;
        *)
            echo -e "${RED}Unknown launcher: ${launcher}${NC}"
            return 1
            ;;
    esac
    
    echo -e "${GREEN}✓ ${name} completed${NC}"
    echo ""
}

{% for benchmark in benchmarks %}
# Run {{ benchmark.name }}
run_benchmark "{{ benchmark.name }}" "{{ benchmark.launcher }}"
{% endfor %}

echo -e "${BLUE}=======================================${NC}"
echo -e "${GREEN}All benchmarks completed!${NC}"
echo -e "${BLUE}Results saved to: ${RESULTS_DIR}${NC}"
echo -e "${BLUE}=======================================${NC}"
