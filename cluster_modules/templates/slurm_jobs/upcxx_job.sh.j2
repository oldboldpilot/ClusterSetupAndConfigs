#!/bin/bash
#SBATCH --job-name={{ job_name }}
#SBATCH --nodes={{ num_nodes }}
#SBATCH --ntasks={{ num_processes }}
#SBATCH --time={{ time_limit }}
#SBATCH --partition={{ partition }}
#SBATCH --output={{ output_file }}
#SBATCH --error={{ error_file }}

# UPC++ Job Script Generated by ClusterSetupAndConfigs
# Author: Olumuyiwa Oluwasanmi
# Framework: UPC++ 2024.3.0 with GASNet-EX 2024.5.0

echo "======================================"
echo "UPC++ Job: {{ job_name }}"
echo "======================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Nodes: {{ num_nodes }}"
echo "Processes: {{ num_processes }}"
echo "GASNet Network: {{ network }}"
echo "Start time: $(date)"
echo "======================================"
echo ""

# Load environment
export PATH={{ upcxx_install }}/bin:/home/linuxbrew/.linuxbrew/bin:$PATH
export LD_LIBRARY_PATH={{ upcxx_install }}/lib:/home/linuxbrew/.linuxbrew/lib:$LD_LIBRARY_PATH

# UPC++ and GASNet configuration
export UPCXX_INSTALL={{ upcxx_install }}
export GASNET_ROOT={{ gasnet_root }}
export UPCXX_NETWORK={{ network }}

# For MPI conduit
{% if network == "mpi" %}
export GASNET_SPAWNFN=S
export GASNET_SSH_SERVERS=$(scontrol show hostname $SLURM_NODELIST | paste -sd " ")
export OMPI_MCA_btl_tcp_if_include=192.168.1.0/24
export OMPI_MCA_oob_tcp_if_include=192.168.1.0/24
{% endif %}

echo "UPC++ Environment:"
echo "  UPCXX_INSTALL=$UPCXX_INSTALL"
echo "  GASNET_ROOT=$GASNET_ROOT"
echo "  UPCXX_NETWORK=$UPCXX_NETWORK"
{% if network == "mpi" %}
echo "  GASNET_SPAWNFN=$GASNET_SPAWNFN"
echo "  GASNET_SSH_SERVERS=$GASNET_SSH_SERVERS"
{% endif %}
echo ""

# Run UPC++ application
echo "Executing: {{ executable }} {{ args }}"
echo ""

{% if network == "mpi" %}
# Use upcxx-run with MPI conduit
upcxx-run -n {{ num_processes }} {{ executable }} {{ args }}
{% else %}
# Use srun for other conduits
srun --mpi=none {{ executable }} {{ args }}
{% endif %}

EXIT_CODE=$?

echo ""
echo "======================================"
echo "Job completed with exit code: $EXIT_CODE"
echo "End time: $(date)"
echo "======================================"

exit $EXIT_CODE
